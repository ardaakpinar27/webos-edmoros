<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, interactive-widget=resizes-content, viewport-fit=cover">
<title>ArMessage</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
/* --- TEMEL AYARLAR --- */
:root {
  --primary: #007AFF; --incoming: #E9E9EB; --outgoing: #007AFF;
  --text-out: #ffffff; --text-in: #000000; --bg-app: #f2f2f7; --danger: #ff3b30;
  /* iPhone ve Çentikli Androidler için Güvenli Alan */
  --safe-top: env(safe-area-inset-top, 20px); 
}

* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
html, body { margin: 0; background: var(--bg-app); height: 100dvh; overflow: hidden; color: #000; overscroll-behavior: none; }

/* --- YÜKLENİYOR EKRANI (SPLASH SCREEN) --- */
#loadingScreen {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: white; z-index: 10000; /* En üstte */
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- GİRİŞ --- */
#loginScreen {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: #f2f2f7; z-index: 9999; 
  display: none; /* Varsayılan GİZLİ, JS ile açacağız */
  flex-direction: column; align-items: center; justify-content: center;
}
.auth-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 340px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.auth-box h2 { color: var(--primary); margin-top: 0; }
input { width: 100%; padding: 16px; margin-bottom: 12px; border: 1px solid #d1d1d6; border-radius: 12px; font-size: 16px; background: #f9f9f9; outline: none; }
input:focus { border-color: var(--primary); background: white; }
.btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 600; cursor: pointer; }
.link { color: var(--primary); margin-top: 15px; display: block; font-size: 15px; cursor: pointer; }

/* --- UYGULAMA --- */
#appScreen { display: none; height: 100dvh; flex-direction: column; background: var(--bg-app); position: relative; }

/* GÜNCELLEME: HEADER SAFE AREA AYARI */
header { 
  /* Yüksekliği güvenli alan kadar arttır */
  height: calc(50px + var(--safe-top)); 
  padding-top: var(--safe-top); /* İçeriği aşağı it */
  background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; 
  border-bottom: 1px solid #e5e5ea; backdrop-filter: blur(20px); flex-shrink: 0; 
}
header span { font-size: 17px; font-weight: 700; color: black; }

main { flex: 1; overflow-y: auto; padding-bottom: 80px; padding-top: 10px; }

/* LISTE STİLLERİ */
.list-title { padding: 10px 20px 5px; font-size: 13px; color: #8e8e93; font-weight: 600; text-transform: uppercase; }

.chat-card {
  display: flex; align-items: center; padding: 15px;
  background: white; margin: 8px 15px; border-radius: 18px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.03); cursor: pointer;
  transition: transform 0.1s; -webkit-user-select: none; user-select: none;
}
.chat-card:active { transform: scale(0.98); background: #f9f9f9; }

.friend-card {
  display: flex; align-items: center; padding: 12px 15px;
  background: white; margin: 0 15px 1px;
  cursor: pointer; -webkit-user-select: none; user-select: none;
}
.friend-card:first-child { border-top-left-radius: 18px; border-top-right-radius: 18px; }
.friend-card:last-child { border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; margin-bottom: 10px; }
.friend-card:active { background: #f0f0f0; }

.avatar { 
  width: 50px; height: 50px; background: #e1e1e6; color: #8e8e93; 
  border-radius: 50%; display: flex; align-items: center; justify-content: center; 
  margin-right: 15px; flex-shrink: 0; font-size: 24px; 
  overflow: hidden; position: relative;
}
.avatar.system { background: var(--primary); color: white; }
.avatar img { width: 100%; height: 100%; object-fit: cover; }

.info { flex: 1; min-width: 0; }
.name-row { display: flex; justify-content: space-between; align-items: baseline; }
.name { font-weight: 600; font-size: 16px; color: #000; }
.time { font-size: 12px; color: #8e8e93; }
.last-msg { font-size: 14px; color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 3px; }

/* FOOTER */
footer { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; background: rgba(249,249,249,0.9); border-top: 1px solid #b3b3b3; display: flex; z-index: 1000; padding-bottom: 5px; backdrop-filter: blur(20px); }
.nav-btn { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; }
.nav-btn.active { color: var(--primary); }
.nav-btn i { font-size: 26px; } .nav-btn span { font-size: 9px; font-weight: 500; }

/* SOHBET EKRANI */
#chatScreen { 
  position: fixed; top: 0; right: 0; width: 100%; height: 100dvh; 
  background: white; z-index: 5000; display: none; flex-direction: column; box-shadow: -5px 0 25px rgba(0,0,0,0.1); 
}
@media(min-width:768px){ #chatScreen { width: 400px; border-left: 1px solid #c6c6c8; } }

/* GÜNCELLEME: CHAT HEADER SAFE AREA */
#chatHeader { 
  height: calc(50px + var(--safe-top)); 
  padding-top: var(--safe-top);
  background: rgba(255,255,255,0.95); border-bottom: 1px solid #b3b3b3; 
  display: flex; align-items: center; padding-left:10px; padding-right:10px;
  flex-shrink: 0; z-index: 10; 
}

#chatBody { flex: 1; overflow-y: auto; padding: 10px 15px; display: flex; flex-direction: column; gap: 6px; background: white; }
#chatFooter { background: #f9f9f9; padding: 8px 10px 15px; display: flex; align-items: center; border-top: 1px solid #b3b3b3; flex-shrink: 0; }

.msg { padding: 8px 14px; border-radius: 18px; max-width: 75%; font-size: 16px; line-height: 1.3; position: relative; word-wrap: break-word; display: flex; flex-direction: column; }
.msg.me { align-self: flex-end; background: var(--outgoing); color: var(--text-out); border-bottom-right-radius: 4px; }
.msg.other { align-self: flex-start; background: var(--incoming); color: var(--text-in); border-bottom-left-radius: 4px; }
.msg-time { font-size: 10px; margin-top: 4px; align-self: flex-end; opacity: 0.7; }

/* AYARLAR */
.settings-container { display: flex; flex-direction: column; justify-content: space-between; height: 100%; padding: 20px 20px 100px; }
.btn-logout { width: 100%; padding: 15px; background: rgba(255, 59, 48, 0.1); color: var(--danger); border: 1px solid rgba(255, 59, 48, 0.2); border-radius: 25px; font-size: 16px; font-weight: 600; backdrop-filter: blur(10px); cursor: pointer; display: flex; align-items: center; justify-content: center; }

/* MENÜLER */
#menuOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 8999; display: none; }
#contextMenu { position: absolute; display: none; z-index: 9000; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 160px; overflow: hidden; }
.ctx-item { padding: 12px 15px; font-size: 14px; color: var(--danger); font-weight: 500; cursor: pointer; display: flex; align-items: center; }
.ctx-item:hover { background: #f2f2f7; }

.hidden { display: none !important; }
.tab { display: none; height: 100%; }
.tab.active { display: block; }
</style>
</head>
<body>

<div id="loadingScreen">
  <div class="loader"></div>
  <h2 style="color:#007AFF; font-weight:700;">ArMessage</h2>
</div>

<input type="file" id="avatarInput" accept="image/*" style="display:none">

<section id="loginScreen">
  <div class="auth-box" id="loginBox">
    <h2>ArMessage</h2>
    <input id="email" type="email" placeholder="E-posta">
    <input id="pass" type="password" placeholder="Şifre">
    <button class="btn-main" onclick="doLogin()">Giriş Yap</button>
    <span class="link" onclick="toRegister()">Kayıt Ol</span>
    <span class="link" onclick="resetPassword()" style="font-size:13px; color:#888; margin-top:10px;">Şifremi Unuttum</span>
    <p id="errorLog" style="color:red; font-size:13px; margin-top:10px;"></p>
  </div>
  <div class="auth-box hidden" id="registerBox">
    <h2>Kayıt Ol</h2>
    <input id="rUser" type="text" placeholder="Kullanıcı Adı">
    <input id="rEmail" type="email" placeholder="E-posta">
    <input id="rPass" type="password" placeholder="Şifre">
    <button class="btn-main" onclick="doRegister()">Kayıt Ol</button>
    <span class="link" onclick="toLogin()">Giriş Yap</span>
    <p id="errorReg" style="color:red; font-size:13px; margin-top:10px;"></p>
  </div>
</section>

<section id="appScreen">
  <header><span>ArMessage</span></header>

  <main>
    <div id="tabChats" class="tab active">
      <div id="chatListDiv"></div>
      <div id="emptyChatState" style="text-align:center; padding:40px; color:#aaa; display:none;">
        <i class="material-icons" style="font-size:48px; opacity:0.5">chat_bubble_outline</i>
        <p>Henüz mesaj yok.<br>Sohbetler burada görünür.</p>
      </div>
    </div>
    
    <div id="tabFriends" class="tab">
      <div style="padding:20px 20px 0;">
        <h2 style="margin:0 0 10px; font-size:26px;">Arkadaşlar</h2>
        <div style="background:white; padding:10px; border-radius:12px; display:flex; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <i class="material-icons" style="color:#aaa; margin-right:5px;">search</i>
          <input id="friendName" placeholder="Kullanıcı adı ara" style="margin:0; flex:1; border:none; background:transparent; padding:0;">
          <button onclick="addFriend()" style="background:transparent; border:none; color:var(--primary); font-weight:600; padding:0 5px;">Ekle</button>
        </div>
        <div id="reqList" style="margin-top:15px;"></div>
      </div>
      <div class="list-title">Kişilerim</div>
      <div id="friendListDiv"></div>
    </div>

    <div id="tabSettings" class="tab">
      <div class="settings-container">
        <div style="text-align:center; padding-top:40px;">
          <div class="avatar" id="myAvatarDisplay" onclick="changeAvatar()" style="width:100px; height:100px; font-size:50px; margin:0 auto 15px; background:white; color:#ccc; border:1px solid #eee; cursor:pointer;">
            <i class="material-icons">add_a_photo</i>
          </div>
          <h2 id="myDisName" style="margin:0;">...</h2>
          <p id="myDisEmail" style="color:#8e8e93; margin-top:5px;">...</p>
        </div>
        <button class="btn-logout" onclick="logOut()">
          <i class="material-icons" style="margin-right:8px;">logout</i> Çıkış Yap
        </button>
      </div>
    </div>
  </main>

  <footer>
    <button class="nav-btn active" onclick="goTab('tabChats', this)"><i class="material-icons">chat_bubble</i><span>Sohbetler</span></button>
    <button class="nav-btn" onclick="goTab('tabFriends', this)"><i class="material-icons">people</i><span>Kişiler</span></button>
    <button class="nav-btn" onclick="goTab('tabSettings', this)"><i class="material-icons">settings</i><span>Ayarlar</span></button>
  </footer>
</section>

<div id="chatScreen">
  <div id="chatHeader">
    <div style="display:flex; align-items:center; color:var(--primary); cursor:pointer; width:80px;" onclick="closeChat()">
      <i class="material-icons">arrow_back_ios</i> <span style="font-size:16px;">Geri</span>
    </div>
    <div style="flex:1; text-align:center;">
      <span id="chatTitle" style="font-weight:600; font-size:16px;">Kişi</span>
    </div>
    <div style="width:80px;"></div>
  </div>
  <div id="chatBody"></div>
  <div id="chatFooter">
    <input id="msgTxt" placeholder="İleti yazın" style="flex:1; border:1px solid #ddd; background:white; border-radius:20px; padding:8px 12px; outline:none; margin:0;">
    <button onclick="sendMsg()" style="width:36px; height:36px; background:var(--primary); color:white; border:none; border-radius:50%; margin-left:10px; display:flex; align-items:center; justify-content:center;">
      <i class="material-icons" style="font-size:18px">arrow_upward</i>
    </button>
  </div>
</div>

<div id="menuOverlay" onclick="closeContextMenu()"></div>
<div id="contextMenu">
  <div class="ctx-item" onclick="confirmDeleteAction()">
    <i class="material-icons" id="ctxIcon">delete</i> <span id="ctxText">Sil</span>
  </div>
</div>

<script>
// FCM SERVER KEY (Legacy)
const FCM_SERVER_KEY = "BURAYA_AAAA_ILE_BASLAYAN_ANAHTARI_YAPISTIR"; 

const firebaseConfig = {
  apiKey: "AIzaSyAMIIMACrsk6mNm3DQpziPHbQpwwTs2LX8",
  authDomain: "olednote.firebaseapp.com",
  projectId: "olednote",
  storageBucket: "olednote.firebasestorage.app",
  messagingSenderId: "797084747250",
  appId: "1:797084747250:web:ad8406c6abe4c699b8d76b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentChatID = null;
let selectedFriendUid = null;
let isLongPress = false;
let longPressTimer;

window.visualViewport.addEventListener('resize', () => {
  if(document.getElementById('chatScreen').style.display === 'flex') {
    document.getElementById('chatBody').scrollTop = document.getElementById('chatBody').scrollHeight;
  }
});

function saveMyToken(token) {
  if(!currentUser) return;
  db.collection('users').doc(currentUser.uid).update({ fcmToken: token }).catch(err => console.log("Token error:", err));
}

function toRegister() { document.getElementById('loginBox').classList.add('hidden'); document.getElementById('registerBox').classList.remove('hidden'); }
function toLogin() { document.getElementById('registerBox').classList.add('hidden'); document.getElementById('loginBox').classList.remove('hidden'); }

function resetPassword() {
  const e = document.getElementById('email').value;
  if(!e) return alert("Lütfen önce E-posta kutusunu doldurun.");
  auth.sendPasswordResetEmail(e).then(() => alert("Şifre sıfırlama bağlantısı gönderildi.")).catch(err => alert("Hata: " + err.message));
}

function doLogin() {
  const e = document.getElementById('email').value; const p = document.getElementById('pass').value;
  document.getElementById('errorLog').innerText = "Giriş yapılıyor...";
  auth.signInWithEmailAndPassword(e, p).catch(err => document.getElementById('errorLog').innerText = err.message);
}

function doRegister() {
  const u = document.getElementById('rUser').value.toLowerCase().trim(); const e = document.getElementById('rEmail').value; const p = document.getElementById('rPass').value;
  if(u.length < 3) return alert("Kısa isim!");
  db.collection('users').where('username','==',u).get().then(snap => {
    if(!snap.empty) { document.getElementById('errorReg').innerText = "Alınmış isim!"; return; }
    auth.createUserWithEmailAndPassword(e, p).then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ username: u, email: e, uid: cred.user.uid });
    }).catch(err => document.getElementById('errorReg').innerText = err.message);
  });
}

function logOut() { auth.signOut(); location.reload(); }

/* --- GÜNCELLENEN AUTH STATE KONTROLÜ (LOADING EKRANI İÇİN) --- */
auth.onAuthStateChanged(user => {
  // Her durumda yükleniyor ekranını gizle (amaç: sonuç belli olunca gizlemek)
  
  if(user) {
    // KULLANICI VARSA
    currentUser = user;
    document.getElementById('loadingScreen').style.display = 'none'; // Yükleniyor'u kaldır
    document.getElementById('loginScreen').style.display = 'none';   // Girişi kaldır
    document.getElementById('appScreen').style.display = 'flex';     // Uygulamayı aç
    
    db.collection('users').doc(user.uid).onSnapshot(doc => {
      if(doc.exists) {
        const data = doc.data();
        document.getElementById('myDisName').innerText = data.username;
        document.getElementById('myDisEmail').innerText = data.email;
        const avDiv = document.getElementById('myAvatarDisplay');
        if(data.photoURL) avDiv.innerHTML = `<img src="${data.photoURL}">`;
        else avDiv.innerHTML = `<i class="material-icons">add_a_photo</i>`;
      }
    });

    loadAllFriends(); loadActiveChats(); loadRequests();
  } else {
    // KULLANICI YOKSA
    document.getElementById('loadingScreen').style.display = 'none'; // Yükleniyor'u kaldır
    document.getElementById('appScreen').style.display = 'none';     // Uygulamayı kaldır
    document.getElementById('loginScreen').style.display = 'flex';   // Giriş ekranını aç
  }
});

function goTab(tabId, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function changeAvatar() { document.getElementById('avatarInput').click(); }
document.getElementById('avatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let width = img.width; let height = img.height; const maxSize = 300;
      if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
      else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      db.collection('users').doc(currentUser.uid).update({ photoURL: dataUrl }).then(() => alert("Profil fotoğrafı güncellendi!"));
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

function addFriend() {
  const target = document.getElementById('friendName').value.trim().toLowerCase();
  if(!target) return;
  db.collection('users').where('username','==',target).get().then(snap => {
    if(snap.empty) return alert("Kullanıcı bulunamadı.");
    const friend = snap.docs[0].data();
    const myName = document.getElementById('myDisName').innerText;
    db.collection('friend_requests').add({ from: currentUser.uid, to: friend.uid, fromName: myName })
      .then(() => { alert("İstek gönderildi."); document.getElementById('friendName').value = ""; });
  });
}
function loadRequests() {
  db.collection('friend_requests').where('to','==',currentUser.uid).onSnapshot(snap => {
    const d = document.getElementById('reqList'); d.innerHTML = "";
    snap.forEach(docSnap => {
      const data = docSnap.data();
      d.innerHTML += `
        <div style="background:white; padding:12px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <span><b>${data.fromName}</b> seni ekledi</span>
          <button onclick="accept('${docSnap.id}','${data.from}','${data.fromName}')" style="background:var(--primary); color:white; border:none; padding:6px 12px; border-radius:15px; cursor:pointer;">Kabul</button>
        </div>`;
    });
  });
}
async function accept(reqId, uid, name) {
  try {
    const myName = document.getElementById('myDisName').innerText;
    const senderSnap = await db.collection('users').doc(uid).get();
    const senderData = senderSnap.data() || {};
    const mySnap = await db.collection('users').doc(currentUser.uid).get();
    const myData = mySnap.data() || {};

    const batch = db.batch();
    batch.set(db.collection('users').doc(currentUser.uid).collection('friends').doc(uid), { uid: uid, username: name, photoURL: senderData.photoURL || null });
    batch.set(db.collection('users').doc(uid).collection('friends').doc(currentUser.uid), { uid: currentUser.uid, username: myName, photoURL: myData.photoURL || null });
    batch.delete(db.collection('friend_requests').doc(reqId));
    await batch.commit();
  } catch (error) { alert("Hata: " + error.message); }
}

function loadAllFriends() {
  db.collection('users').doc(currentUser.uid).collection('friends').onSnapshot(snap => {
    const d = document.getElementById('friendListDiv');
    let html = `<div class="friend-card" onclick="openSystemChat()"><div class="avatar system"><i class="material-icons">verified</i></div><div class="info"><div class="name">ArMessage <i class="material-icons verified-badge">verified</i></div><div class="time" style="color:var(--primary);">Resmi Hesap</div></div></div>`;
    snap.forEach(docSnap => {
      const f = docSnap.data();
      let avatarHtml = f.photoURL ? `<img src="${f.photoURL}">` : `<i class="material-icons">person</i>`;
      html += `<div class="friend-card" oncontextmenu="handleRightClick(event, '${f.uid}')" ontouchstart="handleTouchStart(event, '${f.uid}')" ontouchend="handleTouchEnd()" ontouchmove="handleTouchMove()" onclick="handleClick('${f.uid}', '${f.username}')"><div class="avatar">${avatarHtml}</div><div class="info"><div class="name">${f.username}</div><div class="time">Profil</div></div></div>`;
    });
    d.innerHTML = html;
  });
}

function loadActiveChats() {
  db.collection('users').doc(currentUser.uid).collection('friends').orderBy('lastMsgTime', 'desc').onSnapshot(snap => {
    const d = document.getElementById('chatListDiv');
    const emptyState = document.getElementById('emptyChatState');
    let html = ""; let hasChat = false;
    snap.forEach(docSnap => {
      const f = docSnap.data();
      if(f.lastMsg) {
        hasChat = true;
        let timeStr = "";
        if(f.lastMsgTime) { const date = f.lastMsgTime.toDate(); timeStr = date.getHours().toString().padStart(2,'0') + ":" + date.getMinutes().toString().padStart(2,'0'); }
        let avatarHtml = f.photoURL ? `<img src="${f.photoURL}">` : `<i class="material-icons">person</i>`;
        html += `<div class="chat-card" oncontextmenu="handleRightClick(event, '${f.uid}')" ontouchstart="handleTouchStart(event, '${f.uid}')" ontouchend="handleTouchEnd()" ontouchmove="handleTouchMove()" onclick="handleClick('${f.uid}', '${f.username}')"><div class="avatar">${avatarHtml}</div><div class="info"><div class="name-row"><span class="name">${f.username}</span><span class="time">${timeStr}</span></div><div class="last-msg">${f.lastMsg}</div></div></div>`;
      }
    });
    d.innerHTML = html;
    emptyState.style.display = hasChat ? 'none' : 'block';
  });
}

function handleRightClick(e, uid) { e.preventDefault(); selectedFriendUid = uid; showContextMenu(e.clientX, e.clientY); }
function handleTouchStart(e, uid) { isLongPress = false; selectedFriendUid = uid; longPressTimer = setTimeout(() => { isLongPress = true; if(navigator.vibrate) navigator.vibrate(50); showContextMenu(e.touches[0].clientX, e.touches[0].clientY); }, 600); }
function handleTouchEnd() { clearTimeout(longPressTimer); }
function handleTouchMove() { clearTimeout(longPressTimer); }
function handleClick(uid, name) { if(!isLongPress) openChat(uid, name); }

function showContextMenu(x, y) {
  const menu = document.getElementById('contextMenu');
  const txt = document.getElementById('ctxText');
  const isChatTab = document.getElementById('tabChats').classList.contains('active');
  txt.innerText = isChatTab ? "Sohbeti Kapat" : "Arkadaşı Sil";
  if (x + 160 > window.innerWidth) x = window.innerWidth - 170;
  menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'block';
  document.getElementById('menuOverlay').style.display = 'block';
}
function closeContextMenu() { document.getElementById('contextMenu').style.display = 'none'; document.getElementById('menuOverlay').style.display = 'none'; }
function confirmDeleteAction() {
  if(!selectedFriendUid) return;
  const isChatTab = document.getElementById('tabChats').classList.contains('active');
  if(isChatTab) {
     if(confirm("Sohbet geçmişi kapatılsın mı?")) {
        db.collection('users').doc(currentUser.uid).collection('friends').doc(selectedFriendUid).update({ lastMsg: firebase.firestore.FieldValue.delete(), lastMsgTime: firebase.firestore.FieldValue.delete() }).then(() => closeContextMenu());
     }
  } else {
     if(confirm("Bu kişiyi tamamen silmek istiyor musun?")) {
        db.collection('users').doc(currentUser.uid).collection('friends').doc(selectedFriendUid).delete().then(() => closeContextMenu());
     }
  }
}

function openSystemChat() {
  currentChatID = "SYSTEM";
  document.getElementById('chatScreen').style.display = 'flex';
  document.getElementById('chatTitle').innerHTML = 'ArMessage <i class="material-icons verified-badge" style="font-size:14px">verified</i>';
  document.getElementById('chatBody').innerHTML = `<div style="text-align:center; color:#8e8e93; font-size:12px; margin-bottom:10px;">Bugün</div><div class="msg other">ArMessage'a Hoşgeldin.</div>`;
}

function openChat(uid, name) {
  currentChatID = [currentUser.uid, uid].sort().join("_");
  document.getElementById('chatScreen').style.display = 'flex';
  document.getElementById('chatTitle').innerText = name;
  const b = document.getElementById('chatBody'); b.innerHTML = "";
  
  db.collection('chats').doc(currentChatID).collection('msgs').orderBy('at').onSnapshot(snap => {
    b.innerHTML = "";
    snap.forEach(docSnap => {
      const m = docSnap.data();
      const cls = m.by === currentUser.uid ? 'me' : 'other';
      let t = "";
      if(m.at) { const d = m.at.toDate(); t = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0'); }
      b.innerHTML += `<div class="msg ${cls}">${m.txt}<span class="msg-time">${t}</span></div>`;
    });
    b.scrollTop = b.scrollHeight;
  });
}

function closeChat() { document.getElementById('chatScreen').style.display = 'none'; }

async function sendMsg() {
  const txt = document.getElementById('msgTxt').value;
  if(!txt) return;
  if(currentChatID === "SYSTEM") return alert("Cevap verilemez.");
  try {
    await db.collection('chats').doc(currentChatID).collection('msgs').add({ txt: txt, by: currentUser.uid, at: firebase.firestore.FieldValue.serverTimestamp() });
    const friendID = currentChatID.replace(currentUser.uid, "").replace("_", "");
    db.collection('users').doc(currentUser.uid).collection('friends').doc(friendID).set({ lastMsg: txt, lastMsgTime: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    db.collection('users').doc(friendID).collection('friends').doc(currentUser.uid).set({ lastMsg: txt, lastMsgTime: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    document.getElementById('msgTxt').value = ""; document.getElementById('msgTxt').focus();
    const friendDoc = await db.collection('users').doc(friendID).get();
    if (friendDoc.exists && friendDoc.data().fcmToken) {
      fetch('https://fcm.googleapis.com/fcm/send', {
        method: 'POST', headers: { 'Authorization': 'key=' + FCM_SERVER_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ "to": friendDoc.data().fcmToken, "notification": { "title": document.getElementById('myDisName').innerText, "body": txt, "sound": "default" } })
      });
    }
  } catch(e) { console.error(e); }
}
</script>
</body>
</html>
