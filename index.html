<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, interactive-widget=resizes-content">
<title>ArMessage</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
/* --- TEMEL AYARLAR --- */
:root {
  --primary: #007AFF; --incoming: #E9E9EB; --outgoing: #007AFF;
  --text-out: #ffffff; --text-in: #000000; --bg-app: #f2f2f7; --danger: #ff3b30;
}
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
html, body { margin: 0; background: var(--bg-app); height: 100dvh; overflow: hidden; color: #000; overscroll-behavior: none; }

/* --- GİRİŞ --- */
#loginScreen {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: #f2f2f7; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.auth-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 340px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.auth-box h2 { color: var(--primary); margin-top: 0; }
input { width: 100%; padding: 16px; margin-bottom: 12px; border: 1px solid #d1d1d6; border-radius: 12px; font-size: 16px; background: #f9f9f9; outline: none; }
input:focus { border-color: var(--primary); background: white; }
.btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 600; cursor: pointer; }
.link { color: var(--primary); margin-top: 15px; display: block; font-size: 15px; cursor: pointer; }

/* --- UYGULAMA --- */
#appScreen { display: none; height: 100dvh; flex-direction: column; background: var(--bg-app); position: relative; }
header { height: 50px; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #e5e5ea; backdrop-filter: blur(20px); flex-shrink: 0; }
header span { font-size: 17px; font-weight: 700; color: black; }
main { flex: 1; overflow-y: auto; padding-bottom: 80px; padding-top: 10px; }

/* LİSTE STİLLERİ */
.list-title { padding: 10px 20px 5px; font-size: 13px; color: #8e8e93; font-weight: 600; text-transform: uppercase; }

.chat-card {
  display: flex; align-items: center; padding: 15px;
  background: white; margin: 8px 15px; border-radius: 18px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.03); cursor: pointer;
  transition: transform 0.1s; -webkit-user-select: none; user-select: none;
}
.chat-card:active { transform: scale(0.98); background: #f9f9f9; }

.friend-card {
  display: flex; align-items: center; padding: 12px 15px;
  background: white; margin: 0 15px 1px;
  cursor: pointer; -webkit-user-select: none; user-select: none;
}
.friend-card:first-child { border-top-left-radius: 18px; border-top-right-radius: 18px; }
.friend-card:last-child { border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; margin-bottom: 10px; }
.friend-card:active { background: #f0f0f0; }

.avatar { 
  width: 50px; height: 50px; background: #e1e1e6; color: #8e8e93; 
  border-radius: 50%; display: flex; align-items: center; justify-content: center; 
  margin-right: 15px; flex-shrink: 0; font-size: 24px; 
  overflow: hidden; position: relative;
}
.avatar.system { background: var(--primary); color: white; }
.avatar img { width: 100%; height: 100%; object-fit: cover; }

.info { flex: 1; min-width: 0; }
.name-row { display: flex; justify-content: space-between; align-items: baseline; }
.name { font-weight: 600; font-size: 16px; color: #000; }
.time { font-size: 12px; color: #8e8e93; }
.last-msg { font-size: 14px; color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 3px; }

/* FOOTER */
footer { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; background: rgba(249,249,249,0.9); border-top: 1px solid #b3b3b3; display: flex; z-index: 1000; padding-bottom: 5px; backdrop-filter: blur(20px); }
.nav-btn { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; }
.nav-btn.active { color: var(--primary); }
.nav-btn i { font-size: 26px; } .nav-btn span { font-size: 9px; font-weight: 500; }

/* SOHBET EKRANI */
#chatScreen { position: fixed; top: 0; right: 0; width: 100%; height: 100dvh; background: white; z-index: 5000; display: none; flex-direction: column; box-shadow: -5px 0 25px rgba(0,0,0,0.1); }
@media(min-width:768px){ #chatScreen { width: 400px; border-left: 1px solid #c6c6c8; } }
#chatHeader { height: 50px; background: rgba(255,255,255,0.95); border-bottom: 1px solid #b3b3b3; display: flex; align-items: center; padding: 0 10px; flex-shrink: 0; z-index: 10; }
#chatBody { flex: 1; overflow-y: auto; padding: 10px 15px; display: flex; flex-direction: column; gap: 6px; background: white; }
#chatFooter { background: #f9f9f9; padding: 8px 10px 15px; display: flex; align-items: center; border-top: 1px solid #b3b3b3; flex-shrink: 0; }

.msg { padding: 8px 14px; border-radius: 18px; max-width: 75%; font-size: 16px; line-height: 1.3; position: relative; word-wrap: break-word; display: flex; flex-direction: column; }
.msg.me { align-self: flex-end; background: var(--outgoing); color: var(--text-out); border-bottom-right-radius: 4px; }
.msg.other { align-self: flex-start; background: var(--incoming); color: var(--text-in); border-bottom-left-radius: 4px; }
.msg-time { font-size: 10px; margin-top: 4px; align-self: flex-end; opacity: 0.7; }

/* AYARLAR */
.settings-container { display: flex; flex-direction: column; justify-content: space-between; height: 100%; padding: 20px 20px 100px; }
.btn-logout { width: 100%; padding: 15px; background: rgba(255, 59, 48, 0.1); color: var(--danger); border: 1px solid rgba(255, 59, 48, 0.2); border-radius: 25px; font-size: 16px; font-weight: 600; backdrop-filter: blur(10px); cursor: pointer; display: flex; align-items: center; justify-content: center; }

/* MENÜLER (Sağ tık) */
#menuOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 8999; display: none; }
#contextMenu { position: absolute; display: none; z-index: 9000; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 160px; overflow: hidden; }
.ctx-item { padding: 12px 15px; font-size: 14px; color: var(--danger); font-weight: 500; cursor: pointer; display: flex; align-items: center; }
.ctx-item:hover { background: #f2f2f7; }

/* --- YENİ EKLENEN: CUSTOM CONFIRM POPUP (GLASSMORPHISM) --- */
#customConfirmOverlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.3); /* Hafif karartma */
  z-index: 10000; display: none;
  align-items: center; justify-content: center;
  backdrop-filter: blur(4px); /* Arkadaki içeriği hafif bulanıklaştır */
  -webkit-backdrop-filter: blur(4px);
}

.custom-modal {
  width: 80%; max-width: 300px;
  background: rgba(255, 255, 255, 0.85); /* Yarı saydam beyaz */
  backdrop-filter: blur(20px); /* Buzlu cam etkisi */
  -webkit-backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  border: 1px solid rgba(255, 255, 255, 0.5);
  animation: popIn 0.2s ease-out;
}

.custom-modal h3 { margin: 0 0 10px; font-size: 18px; font-weight: 600; color: #000; }
.custom-modal p { margin: 0 0 20px; font-size: 14px; color: #666; line-height: 1.4; }

.modal-actions { display: flex; justify-content: space-between; gap: 10px; }
.modal-btn {
  flex: 1; padding: 12px; border: none; border-radius: 12px;
  font-size: 16px; font-weight: 600; cursor: pointer;
  background: transparent;
}
.btn-cancel { background: #e5e5ea; color: #000; }
.btn-confirm { background: #ff3b30; color: white; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }

@keyframes popIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.hidden { display: none !important; }
.tab { display: none; height: 100%; }
.tab.active { display: block; }
</style>
</head>
<body>

<input type="file" id="avatarInput" accept="image/*" style="display:none">

<section id="loginScreen">
  <div class="auth-box" id="loginBox">
    <h2>ArMessage</h2>
    <input id="email" type="email" placeholder="E-posta">
    <input id="pass" type="password" placeholder="Şifre">
    <button class="btn-main" onclick="doLogin()">Giriş Yap</button>
    <span class="link" onclick="toRegister()">Kayıt Ol</span>
    <span class="link" onclick="resetPassword()" style="font-size:13px; color:#888; margin-top:10px;">Şifremi Unuttum</span>
    <p id="errorLog" style="color:red; font-size:13px; margin-top:10px;"></p>
  </div>
  <div class="auth-box hidden" id="registerBox">
    <h2>Kayıt Ol</h2>
    <input id="rUser" type="text" placeholder="Kullanıcı Adı">
    <input id="rEmail" type="email" placeholder="E-posta">
    <input id="rPass" type="password" placeholder="Şifre">
    <button class="btn-main" onclick="doRegister()">Kayıt Ol</button>
    <span class="link" onclick="toLogin()">Giriş Yap</span>
    <p id="errorReg" style="color:red; font-size:13px; margin-top:10px;"></p>
  </div>
</section>

<section id="appScreen">
  <header><span>ArMessage</span></header>

  <main>
    <div id="tabChats" class="tab active">
      <div id="chatListDiv"></div>
      <div id="emptyChatState" style="text-align:center; padding:40px; color:#aaa; display:none;">
        <i class="material-icons" style="font-size:48px; opacity:0.5">chat_bubble_outline</i>
        <p>Henüz mesaj yok.<br>Sohbetler burada görünür.</p>
      </div>
    </div>
    
    <div id="tabFriends" class="tab">
      <div style="padding:20px 20px 0;">
        <h2 style="margin:0 0 10px; font-size:26px;">Arkadaşlar</h2>
        <div style="background:white; padding:10px; border-radius:12px; display:flex; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <i class="material-icons" style="color:#aaa; margin-right:5px;">search</i>
          <input id="friendName" placeholder="Kullanıcı adı ara" style="margin:0; flex:1; border:none; background:transparent; padding:0;">
          <button onclick="addFriend()" style="background:transparent; border:none; color:var(--primary); font-weight:600; padding:0 5px;">Ekle</button>
        </div>
        <div id="reqList" style="margin-top:15px;"></div>
      </div>
      <div class="list-title">Kişilerim</div>
      <div id="friendListDiv"></div>
    </div>

    <div id="tabSettings" class="tab">
      <div class="settings-container">
        <div style="text-align:center; padding-top:40px;">
          <div class="avatar" id="myAvatarDisplay" onclick="changeAvatar()" style="width:100px; height:100px; font-size:50px; margin:0 auto 15px; background:white; color:#ccc; border:1px solid #eee; cursor:pointer;">
            <i class="material-icons">add_a_photo</i>
          </div>
          <h2 id="myDisName" style="margin:0;">...</h2>
          <p id="myDisEmail" style="color:#8e8e93; margin-top:5px;">...</p>
        </div>
        <button class="btn-logout" onclick="logOut()">
          <i class="material-icons" style="margin-right:8px;">logout</i> Çıkış Yap
        </button>
      </div>
    </div>
  </main>

  <footer>
    <button class="nav-btn active" onclick="goTab('tabChats', this)"><i class="material-icons">chat_bubble</i><span>Sohbetler</span></button>
    <button class="nav-btn" onclick="goTab('tabFriends', this)"><i class="material-icons">people</i><span>Kişiler</span></button>
    <button class="nav-btn" onclick="goTab('tabSettings', this)"><i class="material-icons">settings</i><span>Ayarlar</span></button>
  </footer>
</section>

<div id="chatScreen">
  <div id="chatHeader">
    <div style="display:flex; align-items:center; color:var(--primary); cursor:pointer; width:80px;" onclick="closeChat()">
      <i class="material-icons">arrow_back_ios</i> <span style="font-size:16px;">Geri</span>
    </div>
    <div style="flex:1; text-align:center;">
      <span id="chatTitle" style="font-weight:600; font-size:16px;">Kişi</span>
    </div>
    <div style="width:80px;"></div>
  </div>
  <div id="chatBody"></div>
  <div id="chatFooter">
    <input id="msgTxt" placeholder="İleti yazın" style="flex:1; border:1px solid #ddd; background:white; border-radius:20px; padding:8px 12px; outline:none; margin:0;">
    <button onclick="sendMsg()" style="width:36px; height:36px; background:var(--primary); color:white; border:none; border-radius:50%; margin-left:10px; display:flex; align-items:center; justify-content:center;">
      <i class="material-icons" style="font-size:18px">arrow_upward</i>
    </button>
  </div>
</div>

<div id="menuOverlay" onclick="closeContextMenu()"></div>
<div id="contextMenu">
  <div class="ctx-item" onclick="triggerCustomConfirm()">
    <i class="material-icons" id="ctxIcon">delete</i> <span id="ctxText">Sil</span>
  </div>
</div>

<div id="customConfirmOverlay">
  <div class="custom-modal">
    <h3 id="modalTitle">Onay</h3>
    <p id="modalMsg">Bu işlemi yapmak istediğine emin misin?</p>
    <div class="modal-actions">
      <button class="modal-btn btn-cancel" onclick="closeCustomConfirm()">Vazgeç</button>
      <button class="modal-btn btn-confirm" id="btnModalConfirm">Evet, Sil</button>
    </div>
  </div>
</div>

<script>
/* --- CONFIG & INIT --- */
const FCM_SERVER_KEY = "BURAYA_AAAA_ILE_BASLAYAN_ANAHTARI_YAPISTIR"; 

const firebaseConfig = {
  apiKey: "AIzaSyAMIIMACrsk6mNm3DQpziPHbQpwwTs2LX8",
  authDomain: "olednote.firebaseapp.com",
  projectId: "olednote",
  storageBucket: "olednote.firebasestorage.app",
  messagingSenderId: "797084747250",
  appId: "1:797084747250:web:ad8406c6abe4c699b8d76b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentChatID = null;
let selectedFriendUid = null;
let isLongPress = false;
let longPressTimer;

window.visualViewport.addEventListener('resize', () => {
  if(document.getElementById('chatScreen').style.display === 'flex') {
    document.getElementById('chatBody').scrollTop = document.getElementById('chatBody').scrollHeight;
  }
});

function saveMyToken(token) {
  if(!currentUser) return;
  db.collection('users').doc(currentUser.uid).update({ fcmToken: token }).catch(err => console.log(err));
}

/* --- AUTH --- */
function toRegister() { document.getElementById('loginBox').classList.add('hidden'); document.getElementById('registerBox').classList.remove('hidden'); }
function toLogin() { document.getElementById('registerBox').classList.add('hidden'); document.getElementById('loginBox').classList.remove('hidden'); }
function resetPassword() {
  const e = document.getElementById('email').value;
  if(!e) return alert("Lütfen önce E-posta kutusunu doldurun.");
  auth.sendPasswordResetEmail(e).then(() => alert("Şifre sıfırlama bağlantısı gönderildi.")).catch(err => alert("Hata: " + err.message));
}
function doLogin() {
  const e = document.getElementById('email').value; const p = document.getElementById('pass').value;
  document.getElementById('errorLog').innerText = "Giriş yapılıyor...";
  auth.signInWithEmailAndPassword(e, p).catch(err => document.getElementById('errorLog').innerText = err.message);
}
function doRegister() {
  const u = document.getElementById('rUser').value.toLowerCase().trim(); const e = document.getElementById('rEmail').value; const p = document.getElementById('rPass').value;
  if(u.length < 3) return alert("Kısa isim!");
  db.collection('users').where('username','==',u).get().then(snap => {
    if(!snap.empty) { document.getElementById('errorReg').innerText = "Alınmış isim!"; return; }
    auth.createUserWithEmailAndPassword(e, p).then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ username: u, email: e, uid: cred.user.uid });
    }).catch(err => document.getElementById('errorReg').innerText = err.message);
  });
}
function logOut() { auth.signOut(); location.reload(); }

auth.onAuthStateChanged(user => {
  if(user) {
    currentUser = user;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'flex';
    db.collection('users').doc(user.uid).onSnapshot(doc => {
      if(doc.exists) {
        const data = doc.data();
        document.getElementById('myDisName').innerText = data.username;
        document.getElementById('myDisEmail').innerText = data.email;
        const avDiv = document.getElementById('myAvatarDisplay');
        if(data.photoURL) avDiv.innerHTML = `<img src="${data.photoURL}">`;
        else avDiv.innerHTML = `<i class="material-icons">add_a_photo</i>`;
      }
    });
    loadAllFriends(); loadActiveChats(); loadRequests();
  } else {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').style.display = 'none';
  }
});

function goTab(tabId, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

/* --- AVATAR --- */
function changeAvatar() { document.getElementById('avatarInput').click(); }
document.getElementById('avatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let width = img.width; let height = img.height; const maxSize = 300;
      if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
      else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      db.collection('users').doc(currentUser.uid).update({ photoURL: dataUrl });
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

/* --- FRIENDSHIP --- */
function addFriend() {
  const target = document.getElementById('friendName').value.trim().toLowerCase();
  if(!target) return;
  db.collection('users').where('username','==',target).get().then(snap => {
    if(snap.empty) return alert("Kullanıcı bulunamadı.");
    const friend = snap.docs[0].data();
    const myName = document.getElementById('myDisName').innerText;
    db.collection('friend_requests').add({ from: currentUser.uid, to: friend.uid, fromName: myName })
      .then(() => { alert("İstek gönderildi."); document.getElementById('friendName').value = ""; });
  });
}
function loadRequests() {
  db.collection('friend_requests').where('to','==',currentUser.uid).onSnapshot(snap => {
    const d = document.getElementById('reqList'); d.innerHTML = "";
    snap.forEach(docSnap => {
      const data = docSnap.data();
      d.innerHTML += `
        <div style="background:white; padding:12px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <span><b>${data.fromName}</b> seni ekledi</span>
          <button onclick="accept('${docSnap.id}','${data.from}','${data.fromName}')" style="background:var(--primary); color:white; border:none; padding:6px 12px; border-radius:15px; cursor:pointer;">Kabul</button>
        </div>`;
    });
  });
}
async function accept(reqId, uid, name) {
  try {
    const myName = document.getElementB
