<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>EdMessenger</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
/* --- TEMEL AYARLAR --- */
* { box-sizing: border-box; font-family: -apple-system, sans-serif; }
body { margin: 0; background: #e5ddd5; height: 100vh; overflow: hidden; }

/* --- GİRİŞ EKRANI --- */
#loginScreen {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: #fff; z-index: 2000;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.auth-box { width: 80%; max-width: 300px; text-align: center; }
input { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
button.btn-main { width: 100%; padding: 15px; background: #075E54; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; }
.link { color: #075E54; margin-top: 20px; display: block; text-decoration: underline; }

/* --- UYGULAMA EKRANI --- */
#appScreen { display: none; height: 100vh; flex-direction: column; }

/* HEADER */
header {
  height: 60px; background: #075E54; color: white;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 15px; font-size: 18px; font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* İÇERİK ALANI (Scroll Edilebilir) */
main { flex: 1; overflow-y: auto; background: white; padding-bottom: 70px; /* Footer payı */ }

/* FOOTER (SABİT - ASLA KAYBOLMAZ) */
footer {
  position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
  background: white; border-top: 1px solid #ddd;
  display: flex; z-index: 1000;
}
.nav-btn {
  flex: 1; border: none; background: white;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  color: #888;
}
.nav-btn.active { color: #075E54; }
.nav-btn i { font-size: 24px; margin-bottom: 2px; }
.nav-btn span { font-size: 10px; }

/* --- SEKMELER --- */
.tab { display: none; padding: 15px; }
.tab.active { display: block; }

/* LİSTE TASARIMI */
.user-row {
  display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;
}
.avatar {
  width: 40px; height: 40px; background: #ddd; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; margin-right: 10px; color: #555;
}

/* SOHBET PENCERESİ */
#chatScreen {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #e5ddd5; z-index: 1500; display: none; flex-direction: column;
}
#chatBody { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
#chatFooter { height: 60px; background: white; padding: 5px; display: flex; align-items: center; }
.msg { padding: 8px 12px; border-radius: 10px; max-width: 70%; font-size: 14px; }
.msg.me { align-self: flex-end; background: #dcf8c6; }
.msg.other { align-self: flex-start; background: white; }

/* Yardımcı Sınıflar */
.hidden { display: none !important; }
</style>
</head>
<body>

<section id="loginScreen">
  <div class="auth-box" id="loginBox">
    <h2 style="color:#075E54">EdMessenger</h2>
    <input id="email" type="email" placeholder="E-posta">
    <input id="pass" type="password" placeholder="Şifre">
    <button class="btn-main" onclick="doLogin()">Giriş Yap</button>
    <span class="link" onclick="toRegister()">Kayıt Ol</span>
    <p id="errorLog" style="color:red; font-size:12px;"></p>
  </div>

  <div class="auth-box hidden" id="registerBox">
    <h2 style="color:#075E54">Kayıt Ol</h2>
    <input id="rUser" type="text" placeholder="Kullanıcı Adı (Küçük harf)">
    <input id="rEmail" type="email" placeholder="E-posta">
    <input id="rPass" type="password" placeholder="Şifre">
    <button class="btn-main" onclick="doRegister()">Kayıt Ol</button>
    <span class="link" onclick="toLogin()">Giriş Yap</span>
    <p id="errorReg" style="color:red; font-size:12px;"></p>
  </div>
</section>

<section id="appScreen">
  <header>
    <span>EdMessenger</span>
    <i class="material-icons" onclick="logOut()">logout</i>
  </header>

  <main>
    <div id="tabChats" class="tab active">
      <h3>Sohbetler</h3>
      <div id="chatListDiv">Yükleniyor...</div>
    </div>

    <div id="tabFriends" class="tab">
      <div style="background:#f0f0f0; padding:10px; border-radius:8px; display:flex;">
        <input id="friendName" placeholder="Kullanıcı adı..." style="margin:0; flex:1;">
        <button onclick="addFriend()" style="width:50px; margin-left:5px; background:#075E54; color:white; border:none; border-radius:5px;">+</button>
      </div>
      <div id="reqList" style="margin-top:15px;"></div>
    </div>

    <div id="tabSettings" class="tab">
      <center>
        <div class="avatar" style="width:80px; height:80px; font-size:40px;"><i class="material-icons">person</i></div>
        <h2 id="myDisName">...</h2>
        <p id="myDisEmail">...</p>
      </center>
    </div>
  </main>

  <footer>
    <button class="nav-btn active" onclick="goTab('tabChats', this)">
      <i class="material-icons">chat</i>
      <span>Sohbet</span>
    </button>
    <button class="nav-btn" onclick="goTab('tabFriends', this)">
      <i class="material-icons">group_add</i>
      <span>Arkadaş</span>
    </button>
    <button class="nav-btn" onclick="goTab('tabSettings', this)">
      <i class="material-icons">settings</i>
      <span>Ayarlar</span>
    </button>
  </footer>
</section>

<div id="chatScreen">
  <header>
    <i class="material-icons" onclick="closeChat()">arrow_back</i>
    <span id="chatTitle" style="margin-left:10px">Kişi</span>
    <div style="flex:1"></div>
  </header>
  <div id="chatBody"></div>
  <div id="chatFooter">
    <input id="msgTxt" placeholder="Mesaj..." style="margin:0; border-radius:20px;">
    <button onclick="sendMsg()" style="width:40px; height:40px; background:#075E54; color:white; border:none; border-radius:50%; margin-left:5px;">
      <i class="material-icons">send</i>
    </button>
  </div>
</div>

<script>
// --- AYARLAR ---
const firebaseConfig = {
  apiKey: "AIzaSyAMIIMACrsk6mNm3DQpziPHbQpwwTs2LX8",
  authDomain: "olednote.firebaseapp.com",
  projectId: "olednote",
  storageBucket: "olednote.firebasestorage.app",
  messagingSenderId: "797084747250",
  appId: "1:797084747250:web:ad8406c6abe4c699b8d76b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;
let currentChatID = null;

// --- GİRİŞ / KAYIT UI ---
function toRegister() {
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('registerBox').classList.remove('hidden');
}
function toLogin() {
  document.getElementById('registerBox').classList.add('hidden');
  document.getElementById('loginBox').classList.remove('hidden');
}

// --- LOGIC ---
function doLogin() {
  const e = document.getElementById('email').value;
  const p = document.getElementById('pass').value;
  auth.signInWithEmailAndPassword(e, p).catch(err => {
    document.getElementById('errorLog').innerText = err.message;
  });
}

function doRegister() {
  const u = document.getElementById('rUser').value.toLowerCase().trim();
  const e = document.getElementById('rEmail').value;
  const p = document.getElementById('rPass').value;
  
  if(u.length < 3) return alert("Kullanıcı adı kısa!");

  // Username kontrolü
  db.collection('users').where('username','==',u).get().then(snap => {
    if(!snap.empty) return alert("Bu isim alınmış!");
    
    auth.createUserWithEmailAndPassword(e, p).then(cred => {
      return db.collection('users').doc(cred.user.uid).set({
        username: u, email: e, uid: cred.user.uid
      });
    }).catch(err => {
      document.getElementById('errorReg').innerText = err.message;
    });
  });
}

function logOut() { auth.signOut(); location.reload(); }

// --- AUTH STATE ---
auth.onAuthStateChanged(user => {
  if(user) {
    currentUser = user;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'flex'; // FLEX ÖNEMLİ
    
    // Bilgileri Çek
    db.collection('users').doc(user.uid).get().then(doc => {
      if(doc.exists) {
        document.getElementById('myDisName').innerText = doc.data().username;
        document.getElementById('myDisEmail').innerText = doc.data().email;
      }
    });

    loadFriends();
    loadRequests();
  } else {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').style.display = 'none';
  }
});

// --- TAB GEÇİŞLERİ ---
function goTab(tabId, btn) {
  // Tüm tabları gizle
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  // İsteneni aç
  document.getElementById(tabId).classList.add('active');
  
  // Buton renklerini sıfırla
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// --- ARKADAŞ EKLEME ---
function addFriend() {
  const target = document.getElementById('friendName').value.trim().toLowerCase();
  if(!target) return;
  
  db.collection('users').where('username','==',target).get().then(snap => {
    if(snap.empty) return alert("Kullanıcı yok!");
    
    const friend = snap.docs[0].data();
    const myName = document.getElementById('myDisName').innerText;

    db.collection('friend_requests').add({
      from: currentUser.uid, to: friend.uid, fromName: myName
    }).then(() => {
      alert("İstek gitti!");
      document.getElementById('friendName').value = "";
    });
  });
}

function loadRequests() {
  db.collection('friend_requests').where('to','==',currentUser.uid)
  .onSnapshot(snap => {
    const d = document.getElementById('reqList');
    d.innerHTML = "";
    snap.forEach(docSnap => {
      const data = docSnap.data();
      d.innerHTML += `
        <div style="background:#e7fce3; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between;">
          <span><b>${data.fromName}</b> ekledi</span>
          <button onclick="accept('${docSnap.id}','${data.from}','${data.fromName}')">Kabul</button>
        </div>`;
    });
  });
}

function accept(reqId, uid, name) {
  // Karşılıklı ekle
  const myName = document.getElementById('myDisName').innerText;
  const batch = db.batch();
  
  const ref1 = db.collection('users').doc(currentUser.uid).collection('friends').doc(uid);
  batch.set(ref1, { uid: uid, username: name });
  
  const ref2 = db.collection('users').doc(uid).collection('friends').doc(currentUser.uid);
  batch.set(ref2, { uid: currentUser.uid, username: myName });
  
  const ref3 = db.collection('friend_requests').doc(reqId);
  batch.delete(ref3);
  
  batch.commit();
}

// --- SOHBET LİSTESİ ---
function loadFriends() {
  db.collection('users').doc(currentUser.uid).collection('friends')
  .onSnapshot(snap => {
    const d = document.getElementById('chatListDiv');
    d.innerHTML = "";
    if(snap.empty) d.innerHTML = "Henüz arkadaş yok.";
    
    snap.forEach(docSnap => {
      const f = docSnap.data();
      d.innerHTML += `
        <div class="user-row" onclick="openChat('${f.uid}','${f.username}')">
          <div class="avatar"><i class="material-icons">person</i></div>
          <b>${f.username}</b>
        </div>`;
    });
  });
}

// --- SOHBET ---
function openChat(uid, name) {
  currentChatID = [currentUser.uid, uid].sort().join("_");
  document.getElementById('chatTitle').innerText = name;
  document.getElementById('chatScreen').style.display = 'flex';
  
  db.collection('chats').doc(currentChatID).collection('msgs')
  .orderBy('at')
  .onSnapshot(snap => {
    const b = document.getElementById('chatBody');
    b.innerHTML = "";
    snap.forEach(docSnap => {
      const m = docSnap.data();
      const cls = m.by === currentUser.uid ? 'me' : 'other';
      b.innerHTML += `<div class="msg ${cls}">${m.txt}</div>`;
    });
    b.scrollTop = b.scrollHeight;
  });
}

function closeChat() { document.getElementById('chatScreen').style.display = 'none'; }

function sendMsg() {
  const t = document.getElementById('msgTxt').value;
  if(!t) return;
  db.collection('chats').doc(currentChatID).collection('msgs').add({
    txt: t, by: currentUser.uid, at: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('msgTxt').value = "";
}
</script>
</body>
</html>
